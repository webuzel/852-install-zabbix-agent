Install Zabbix Agent
=========
Ansible-плейбук для установки zabbix-агента на Windows-копьютеры и регистрации их на zabbix-сервере.
(С небольшой доработкой также возможна и установка на linux и регистрация SNMP-узлов)

Установка
------------
- Подготовить папку с виртуальной средой выполнения (`python3 -m venv venv`) и активировать её (`source /venv/bin/activate`). Также можно воспользоваться соответствующими скриптами из "комплекта поставки".
- Установить необходимые библиотеки для работы с kerberos-аутентификацией в linux, коллекции для ansible и библиотеки для python (cм. текст скрипта `install_collection.sh`). И обязательно настроить файл `/etc/krb5.conf` под условия сети (домена).
- Проверить, что на Windows-компьютерах есть условия для подключения к ним инструментами ansible: https://docs.ansible.com/ansible/latest/os_guide/windows_setup.html


Настройка
------------
- Основные параметры задаются в переменных в bash-скрипте `853-install-zabbix-agent.sh`
- Список компьютеров (хостов, узлов) задаётся в файле `hosts.windows`. Там же можно задать и особенные настройки для каждого из хостов.
- (Имена/пароли из файлов убраны)

Запуск
------------
- Для установки на компьютерах и добавления (регистрации) на сервере: `bash 853-install-zabbix-agent.sh`
- Для установки: `bash 853-install-zabbix-agent.sh -install`
- Для добавления: `bash 853-install-zabbix-agent.sh -add`

Скрипт отдельно запросит имя и пароль для установки и имя и пароль для добавления (регистрации).
Для установки нужна учетная запись (доменная), у которой административные полномочия на компьютерах.
Для добавления на сервер нужны реквизиты учётной записи с сервера zabbix, у которой есть (как минимум) полномочия добавлять узлы в настройках zabbix.

**Примечание:**
В скрипте используется две коллекции:
  - community.zabbix
  - zabbix.zabbix

Коллекция community.zabbix умеет устанавливать zabbix-агента на Windows-компьютеры, но в данный момент у неё неполадки с регистрацией узлов на Zabbix-сервере (предположительно из-за начавшихся в версии 6.4 изменений в API серверной части).
Коллекция zabbix.zabbix не умеет работать с Windows-компьютерами (на этапе установки), но зато отлично регистрирует узлы на сервере. (Кстати, это коллекция от самих разработчиков Zabbix).
У коллекций разный набор (названия) перменных и логика их использования.

**Важно:** 
Иногда процесс установки отрабатывает не до конца на каких-то узлах. Например, не может остановить или перезапустить сервис на удалённой машине, если открыта оснастка "Сервисы" "Панели управления" на компьютере (её нужно закрыть и, в идеале, вообще завершить свою rdp-сессию на удалённой машине). Повторный запуск скрипта с теми же параметрами обычно проходит штатно.

Добавление хостов на Zabbix-сервер (интерфейс) выполняется по FQDN (не по IP-адресу). Это можно поменять в hosts.windows.

Что-то непременно упущено. По-любому придётся разбираться самостоятельно %)

**TODO:** 
Разобраться с установкой свежей версии ansible-агента, без необходимости указывать конкретную версию (и ссылку на её скачивание) в скрипте.
Разобраться с регистрацией хостов на ansible-сервере коллекцией community.zabbix (сейчас она не работает).
Автоматизировать добавление по IP-адресу интерфеса хоста (в случае включения такого варианта в настройках).